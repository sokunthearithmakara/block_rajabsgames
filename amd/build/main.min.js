define("block_rajabsgames/main",["exports","jquery","mod_interactivevideo/type/base","core_form/dynamicform","core/templates","mod_interactivevideo/viewannotation"],(function(_exports,_jquery,_base,_dynamicform,_templates,_viewannotation){function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}
/**
   * TODO describe module main
   *
   * @module     block_rajabsgames/main
   * @copyright  2025 Sokunthearith Makara <sokunthearithmakara@gmail.com>
   * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
   */Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.default=void 0,_jquery=_interopRequireDefault(_jquery),_base=_interopRequireDefault(_base),_dynamicform=_interopRequireDefault(_dynamicform),_templates=_interopRequireDefault(_templates);class RajabsGames extends _base.default{async init(){let self=this;if(!this.isEditMode()&&!this.isPreviewMode()){const games=this.annotations.find((x=>"rajabsgames"==x.type));if(!games)return;let block=await _jquery.default.ajax({url:M.cfg.wwwroot+"/blocks/rajabsgames/ajax.php",method:"POST",dataType:"text",data:{action:"get_badges",sesskey:M.cfg.sesskey,courseid:self.course}}),badges=games.content;badges=JSON.parse(badges||"[]");let progress=await _jquery.default.ajax({url:M.cfg.wwwroot+"/blocks/rajabsgames/ajax.php",method:"POST",dataType:"text",data:{action:"get_completiondetails",sesskey:M.cfg.sesskey,courseid:self.course,cmid:self.interaction,userid:self.userid}});if(progress=JSON.parse(progress||"[]"),progress=JSON.parse(progress||"[]"),progress=progress.map((x=>JSON.parse(x))),progress=progress.find((x=>x.id==games.id)),progress=progress&&progress.gameprogress||[],0==badges.length)return;let badgeconfig=JSON.parse(block);if(badgeconfig=JSON.parse(badgeconfig||"[]"),badges=badges.map((badge=>{badge.isblock=!0,badge.unused=!1;let badgedata=badgeconfig.find((x=>x.id==badge.badgeid));return badgedata?(badge.name=badgedata.name,badge.picture=badgedata.picture,badge.id=badgedata.id):badge.id=0,progress.find((x=>x.name==badge.uniqueid))&&(badge.completed=!0),badge})),badges=badges.filter((x=>0!=x.id)),1==games.intg2){let badgesforstatus=[];badges.forEach((badge=>{badge=JSON.parse(JSON.stringify(badge)),badgesforstatus.find((x=>x.id==badge.id))||badgesforstatus.push(badge)})),badgesforstatus=badgesforstatus.map((badge=>(badge.mine=progress.filter((x=>x.id==badge.id)).length,badge.badgecount=badges.filter((x=>x.id==badge.id)).length,badge.completed=badge.mine==badge.badgecount,badge.classes=badge.mine<badge.badgecount||0==badge.badgecount?"filter":"",badge)));let status=await _templates.default.render("block_rajabsgames/status",{badges:badgesforstatus});(0,_jquery.default)(".navbar .navigation").prepend(status),(0,_jquery.default)('[data-region="chapterwrapper"] > div').append(status)}progress=progress.filter((x=>badges.find((y=>y.uniqueid==x.name))));let cummulatedXP=0;progress.forEach((x=>{cummulatedXP+=Number(x.xp)}));let incompletedBadges=badges.filter((x=>!x.completed));if(0==incompletedBadges.length)return;let badgeHTML=await _templates.default.render("block_rajabsgames/badge",{badges:incompletedBadges}),$badgeHTML=(0,_jquery.default)("<div>"+badgeHTML+"</div>");incompletedBadges=incompletedBadges.map((x=>{let $el=$badgeHTML.find('[data-id="'.concat(x.id,'"]'));return $el=$el.clone(),$el.addClass("pulse-sm jellyIn"),$el.attr("data-name",x.uniqueid),$el.attr("data-xp",x.xp),x.xp>0&&$el.append('<small class="text-muted">\n                        '.concat(x.xp," <sup>").concat(M.util.get_string("xp","block_rajabsgames"),"</sup></small>")),x.html=$el.prop("outerHTML"),x.classes=self.getPosition(x.position),x})),(0,_jquery.default)(document).off("timeupdate.games").on("timeupdate.games",(async function(e){const t=Number(e.originalEvent.detail.time),badge=incompletedBadges.find((x=>x.timestamp<=t&&x.timestamp+5>=t&&!x.completed));let isEmpty=0==(0,_jquery.default)(".video-block").find("li").length;if(!badge&&!isEmpty)return(0,_jquery.default)(".video-block").empty(),void(0,_jquery.default)(".video-block").attr("class","video-block");(0,_jquery.default)(".video-block li").length>0||badge&&((0,_jquery.default)(".video-block").empty(),(0,_jquery.default)(".video-block").attr("class","video-block"),(0,_jquery.default)(".video-block").addClass(badge.classes+" p-2"),(0,_jquery.default)(".video-block").append(badge.html),1==games.intg3&&self.player.pause())})),(0,_jquery.default)(document).off("click",".video-block li").on("click",".video-block li",(function(e){if(e.preventDefault(),e.stopImmediatePropagation(),1==games.intg2){let bdg=(0,_jquery.default)(document).find('.rg_badgestatus_item[data-id="'+(0,_jquery.default)(this).attr("data-id")+'"]');if(bdg.length>0){let count=bdg.find(".badge-count");count.attr("data-count",Number(count.attr("data-count"))+1),count.attr("data-count")==count.attr("data-total")&&bdg.find("img").removeClass("filter"),bdg.find("img").addClass("jellyIn"),setTimeout((()=>{bdg.find("img").removeClass("jellyIn")}),300),count.text(count.attr("data-count"))}}window.fireConfetti(),(0,_jquery.default)(this).removeClass("jellyIn").addClass("jellyIn").fadeOut(300,(()=>{(0,_jquery.default)(this).remove()}));let details={};const completeTime=new Date;let windowAnno=window.ANNOS.find((x=>x.id==games.id));details.xp=cummulatedXP+Number((0,_jquery.default)(this).data("xp")),cummulatedXP=details.xp,details.duration=windowAnno.duration+(completeTime.getTime()-windowAnno.newstarttime),details.timecompleted=completeTime.getTime(),details.hasDetails=!1,progress.push({id:(0,_jquery.default)(this).data("id"),xp:(0,_jquery.default)(this).data("xp"),name:(0,_jquery.default)(this).data("name")}),details.gameprogress=progress,details.completed=details.xp==games.xp,self.toggleCompletion(games.id,"automatic",details),self.addNotification(M.util.get_string("xpearned","mod_interactivevideo",Number((0,_jquery.default)(this).data("xp"))),"success"),incompletedBadges=incompletedBadges.filter((x=>x.uniqueid!=(0,_jquery.default)(this).data("name"))),0==incompletedBadges.length&&(0,_jquery.default)(document).off("timeupdate.games")}))}}toggleCompletion(id){let type=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"automatic",details=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},self=this;if(self.isEditMode())return Promise.resolve();if(self.isPreviewMode())return self.addNotification(M.util.get_string("completionnotrecordedinpreviewmode","mod_interactivevideo")),Promise.resolve();const gradableitems=self.annotations.filter((x=>"1"==x.hascompletion)),totalXp=gradableitems.map((_ref=>{let{xp:xp}=_ref;return Number(xp)})).reduce(((a,b)=>a+b),0);let completedItems=gradableitems.filter((_ref2=>{let{completed:completed}=_ref2;return completed})),earnedXp=completedItems.map((_ref3=>{let{earned:earned}=_ref3;return Number(earned)})).reduce(((a,b)=>a+b),0);completedItems=completedItems.map((_ref4=>{let{id:id}=_ref4;return id}));let thisItem=gradableitems.find((_ref5=>{let{id:itemId}=_ref5;return itemId==id})),completionDetails={id:id};const completeTime=new Date;completionDetails.hasDetails=!!details.details,details.hasDetails&&(completionDetails.hasDetails=!0),completionDetails.xp=details.xp||thisItem.xp,completionDetails.timecompleted=details.timecompleted||completeTime.getTime();const completiontime=completeTime.toLocaleString();let completed;return completionDetails.gameprogress=details.gameprogress||[],completionDetails.reportView=details.reportView||"<span data".concat(self.isBS5?"-bs":"",'-toggle="tooltip" data').concat(self.isBS5?"-bs":"",'-html="true"\n                 title=\'<span class="d-flex flex-column align-items-start"><span><i class="bi bi-calendar iv-mr-2"></i>\n                 ').concat(completiontime,"</span></span>'>\n                 <i class=\"fa fa-").concat(details.completed?"check text-success":"circle-o text-secondary",' "></i><br>\n                 <span>').concat(Number(completionDetails.xp),"</span></span>"),details.completed&&completedItems.push(id.toString()),thisItem.earned>0&&(earnedXp-=Number(thisItem.earned)),earnedXp+=Number(completionDetails.xp),completedItems=[...new Set(completedItems)],completed=Number(self.completionpercentage)>0?completedItems.length/gradableitems.length*100>=Number(self.completionpercentage)?1:0:gradableitems.length==completedItems.length?1:0,new Promise((resolve=>{_jquery.default.ajax({url:"".concat(M.cfg.wwwroot,"/mod/interactivevideo/ajax.php"),method:"POST",dataType:"text",data:{action:"save_progress",markdone:"mark-done",sesskey:M.cfg.sesskey,id:self.interaction,uid:self.userid,percentage:completedItems.length/gradableitems.length*100,g:parseFloat(earnedXp/totalXp*self.grademax).toFixed(2),gradeiteminstance:self.gradeiteminstance,c:completed,xp:earnedXp,completeditems:JSON.stringify(completedItems),completiondetails:JSON.stringify(completionDetails),details:JSON.stringify(details.details||{}),annotationtype:thisItem.type,token:self.token,cmid:self.cm,completionid:self.completionid,contextid:thisItem.contextid,updatestate:self.completionpercentage>0||0!=Object.keys(self.extracompletion).length?1:0,courseid:self.course},success:res=>{const annotations=self.annotations.map((x=>(x.id==id&&(x.completed=!!details.completed||"pending",x.earned=completionDetails.xp||0),x)));(0,_viewannotation.renderAnnotationItems)(annotations,self.start,self.end-self.start),thisItem.earned=completionDetails.xp||0,new Audio(M.cfg.wwwroot+"/mod/interactivevideo/sounds/point-awarded.mp3").play(),self.dispatchEvent("completionupdated",{annotations:annotations,completionpercentage:completedItems.length/gradableitems.length*100,grade:parseFloat(earnedXp/totalXp*self.grademax).toFixed(2),completed:completed,xp:earnedXp,completeditems:completedItems,target:thisItem,action:"mark-done",type:type,response:res}),resolve()}})}))}addAnnotation(annotations,timestamp,coursemodule){(0,_jquery.default)("#addcontent, #importcontent").addClass("no-pointer-events");let self=this;this.annotations=annotations;const startHMS=self.convertSecondsToHMS(self.start),endHMS=self.convertSecondsToHMS(self.end),data={id:0,timestamp:-1,timestampassist:timestamp>0?self.convertSecondsToHMS(timestamp):startHMS,title:self.prop.title,start:startHMS,end:endHMS,contextid:M.cfg.contextid,type:self.prop.name,courseid:self.course,cmid:coursemodule,annotationid:self.interaction,hascompletion:self.prop.hascompletion?1:0};(0,_jquery.default)("#annotationwrapper table").hide(),(0,_jquery.default)("#annotationwrapper").append('<div id="form" class="w-100 p-3"></div>'),(0,_jquery.default)("#contentmodal").modal("hide"),(0,_jquery.default)("#addcontentdropdown a").removeClass("active");const selector=document.querySelector("#annotationwrapper #form"),decisionform=new _dynamicform.default(selector,self.prop.form);decisionform.load(data),self.onEditFormLoaded(decisionform),self.validateTimestampFieldValue("timestampassist","timestamp"),(0,_jquery.default)(document).off("click","#cancel-submit").on("click","#cancel-submit",(function(e){e.preventDefault(),e.stopImmediatePropagation(),(0,_jquery.default)("#annotationwrapper #form").remove(),(0,_jquery.default)("#annotationwrapper table").show(),(0,_jquery.default)("#addcontent, #importcontent").removeClass("no-pointer-events"),(0,_jquery.default)("#annotation-canvas #badge-preview").remove()})),(0,_jquery.default)(document).off("click","#submitform-submit").on("click","#submitform-submit",(function(e){e.preventDefault(),e.stopImmediatePropagation();decisionform.trigger(decisionform.events.SUBMIT_BUTTON_PRESSED).defaultPrevented||decisionform.submitFormAjax(),(0,_jquery.default)("#annotation-canvas #badge-preview").remove()})),decisionform.addEventListener(decisionform.events.SERVER_VALIDATION_ERROR,(e=>{e.stopImmediatePropagation(),self.onEditFormLoaded(decisionform),self.validateTimestampFieldValue("timestampassist","timestamp")})),decisionform.addEventListener(decisionform.events.FORM_SUBMITTED,(e=>{e.preventDefault(),e.stopImmediatePropagation(),_jquery.default.ajax({url:M.cfg.wwwroot+"/mod/interactivevideo/ajax.php",method:"POST",dataType:"text",data:{action:"get_item",id:e.detail.id,sesskey:M.cfg.sesskey,contextid:M.cfg.courseContextId,token:self.token,cmid:self.cm},success:function(data){const newAnnotation=JSON.parse(data);self.dispatchEvent("annotationupdated",{annotation:newAnnotation,action:"add"})}}),(0,_jquery.default)("#annotationwrapper #form").remove(),(0,_jquery.default)("#annotationwrapper table").show(),(0,_jquery.default)("#addcontent, #importcontent").removeClass("no-pointer-events")}))}editAnnotation(annotations,id){(0,_jquery.default)("#addcontent, #importcontent").addClass("no-pointer-events"),this.annotations=annotations;let self=this;const annotation=annotations.find((x=>x.id==id)),timestamp=annotation.timestamp,timestampassist=this.convertSecondsToHMS(timestamp);annotation.timestampassist=timestampassist,annotation.start=this.convertSecondsToHMS(this.start),annotation.end=this.convertSecondsToHMS(this.end),annotation.contextid=M.cfg.contextid,(0,_jquery.default)("#annotationwrapper table").hide(),(0,_jquery.default)("#annotationwrapper").append('<div id="form" class="w-100 p-3"></div>');const selector=document.querySelector("#annotationwrapper #form"),decisionform=new _dynamicform.default(selector,self.prop.form);decisionform.load(annotation),self.onEditFormLoaded(decisionform),self.validateTimestampFieldValue("timestampassist","timestamp"),(0,_jquery.default)(document).off("click","#cancel-submit").on("click","#cancel-submit",(function(e){e.preventDefault(),e.stopImmediatePropagation(),(0,_jquery.default)("#annotationwrapper #form").remove(),(0,_jquery.default)("#annotationwrapper table").show(),(0,_jquery.default)("#addcontent, #importcontent").removeClass("no-pointer-events"),(0,_jquery.default)("#annotation-canvas #badge-preview").remove()})),(0,_jquery.default)(document).off("click","#submitform-submit").on("click","#submitform-submit",(function(e){e.preventDefault(),e.stopImmediatePropagation();decisionform.trigger(decisionform.events.SUBMIT_BUTTON_PRESSED).defaultPrevented||decisionform.submitFormAjax(),(0,_jquery.default)("#annotation-canvas #badge-preview").remove()})),decisionform.addEventListener(decisionform.events.SERVER_VALIDATION_ERROR,(e=>{e.stopImmediatePropagation(),self.onEditFormLoaded(decisionform),self.validateTimestampFieldValue("timestampassist","timestamp")})),decisionform.addEventListener(decisionform.events.FORM_SUBMITTED,(e=>{e.preventDefault(),e.stopImmediatePropagation(),this.annotations=this.annotations.filter((x=>x.id!=id)),_jquery.default.ajax({url:M.cfg.wwwroot+"/mod/interactivevideo/ajax.php",method:"POST",dataType:"text",data:{action:"get_item",id:e.detail.id,sesskey:M.cfg.sesskey,contextid:M.cfg.courseContextId,token:self.token,cmid:self.cm}}).done((function(data){const updated=JSON.parse(data);self.dispatchEvent("annotationupdated",{annotation:updated,action:"edit"})})),(0,_jquery.default)("#annotationwrapper #form").remove(),(0,_jquery.default)("#annotationwrapper table").show(),(0,_jquery.default)("#addcontent, #importcontent").removeClass("no-pointer-events")}))}getPosition(){let classes="";switch(arguments.length>0&&void 0!==arguments[0]?arguments[0]:"centercenter"){case"top-left":classes="align-items-start justify-content-start";break;case"top-center":classes="align-items-start justify-content-center";break;case"top-right":classes="align-items-start justify-content-end";break;case"center-left":classes="align-items-center justify-content-start";break;case"center-center":classes="align-items-center justify-content-center";break;case"center-right":classes="align-items-center justify-content-end";break;case"bottom-left":classes="align-items-end justify-content-start";break;case"bottom-center":classes="align-items-end justify-content-center";break;case"bottom-right":classes="align-items-end justify-content-end"}return classes}onEditFormLoaded(form,event){let self=this,body=(0,_jquery.default)("#annotationwrapper #form"),positions=[{name:"top-left",label:M.util.get_string("topleft","block_rajabsgames")},{name:"top-center",label:M.util.get_string("topcenter","block_rajabsgames")},{name:"top-right",label:M.util.get_string("topright","block_rajabsgames")},{name:"center-left",label:M.util.get_string("centerleft","block_rajabsgames")},{name:"center-center",label:M.util.get_string("centercenter","block_rajabsgames"),selected:"selected"},{name:"center-right",label:M.util.get_string("centerright","block_rajabsgames")},{name:"bottom-left",label:M.util.get_string("bottomleft","block_rajabsgames")},{name:"bottom-center",label:M.util.get_string("bottomcenter","block_rajabsgames")},{name:"bottom-right",label:M.util.get_string("bottomright","block_rajabsgames")}];const checkContentField=()=>{if((0,_jquery.default)("[name=content]").length>0){let dest=(0,_jquery.default)("[name=content]").val(),badgeoptions=(0,_jquery.default)("[name=badges]").val();badgeoptions=badgeoptions?JSON.parse(badgeoptions):[],""==dest||0==JSON.parse(dest).length?(0,_jquery.default)("#destination-list").append('<div class="input-group mb-1 d-none">\n                <input type="text" class="uniqueid form-control" value=""\n                     placeholder="'.concat(M.util.get_string("uniquename","block_rajabsgames"),'">\n                <select class="custom-select form-select badgeoption">\n                <option value="">').concat(M.util.get_string("selectabadge","block_rajabsgames"),"</option>\n                        ").concat(badgeoptions.map((badge=>'<option value="'.concat(badge.id,'">').concat(badge.name,"</option>"))).join(""),'\n                </select>\n                <select class="custom-select form-select positionoption">\n                        ').concat(positions.map((position=>'<option value="'.concat(position.name,'" ').concat(position.selected,">").concat(position.label,"</option>"))).join(""),'\n                </select>\n                <input type="text" class="form-control xp" value="0" placeholder="').concat(M.util.get_string("xp","block_rajabsgames"),'">\n                <input type="text" value="').concat(this.convertSecondsToHMS(this.start),'"\n                placeholder="00:00:00" style="max-width: 120px;" class="form-control timestamp-input"\n                 title="').concat(M.util.get_string("rightclicktousecurrenttime","block_rajabsgames"),'">\n                <div class="input-group-append">\n                <button class="btn goto-dest btn-secondary px-2" type="button"><i class="bi bi-play-fill fs-25px"></i></button>\n                <button class="btn add-dest btn-secondary" type="button"><i class="bi bi-plus-lg fs-unset"></i></button>\n                <button class="btn btn-danger delete-dest disabled" disabled type="button">\n                    <i class="bi bi-trash3-fill fs-unset"></i></button></div></div>')):(dest=JSON.parse(dest),dest.forEach(((d,i)=>{(0,_jquery.default)("#destination-list").append('<div class="input-group mb-1">\n                    <input type="text" class="uniqueid form-control" value="'.concat(d.uniqueid,'"\n                     placeholder="').concat(M.util.get_string("uniquename","block_rajabsgames"),'">\n                    <select class="custom-select form-select badgeoption">\n                        <option value="">').concat(M.util.get_string("selectabadge","block_rajabsgames"),"</option>\n                                ").concat(badgeoptions.map((badge=>'<option value="'.concat(badge.id,'" ').concat(badge.id==d.badgeid?"selected":"",">").concat(badge.name,"</option>"))).join(""),'\n                        </select>\n                    <select class="custom-select form-select positionoption">\n                            ').concat(positions.map((position=>'<option value="'.concat(position.name,'"\n                             ').concat(position.name==d.position?"selected":"",">").concat(position.label,"</option>"))).join(""),'\n                    </select>\n                    <input type="text" class="form-control xp" value="').concat(d.xp||0,'"\n                     placeholder="').concat(M.util.get_string("xp","block_rajabsgames"),'">\n                    <input type="text" value="').concat(this.convertSecondsToHMS(d.timestamp),'"\n                    placeholder="00:00:00" style="max-width: 120px;" class="form-control timestamp-input"\n                     title="').concat(M.util.get_string("rightclicktousecurrenttime","block_rajabsgames"),'">\n                    <div class="input-group-append">\n                    <button class="btn goto-dest btn-secondary px-2" type="button"><i class="bi bi-play-fill fs-25px"></i></button>\n                    <button class="btn add-dest btn-secondary" type="button"><i class="bi bi-plus-lg fs-unset"></i></button>\n                    <button class="btn btn-danger delete-dest ').concat(0==i?"disabled":"",'" ').concat(0==i?"disabled":"",'\n                    type="button"><i class="bi bi-trash3-fill fs-unset"></i></button></div></div>'))})),(0,_jquery.default)('.input-group [type="text"]').trigger("input"))}else requestAnimationFrame(checkContentField)};return requestAnimationFrame(checkContentField),body.off("click","#add-destination").on("click","#add-destination",(function(){(0,_jquery.default)("#destination-list .input-group").last().find(".add-dest").trigger("click")})),body.off("click",".input-group .add-dest").on("click",".input-group .add-dest",(async function(e){e.stopImmediatePropagation();let $parent=(0,_jquery.default)(this).closest(".input-group"),$row=$parent.clone();$row.removeClass("d-none");let currentTime=await self.player.getCurrentTime();$row.find("input.timestamp-input").val(self.convertSecondsToHMS(currentTime)),$row.find(".uniqueid").val(""),$row.find(".xp").val(0),$row.find(".delete-dest").removeClass("disabled").removeAttr("disabled"),$parent.after($row),$parent.find('[type="text"]').trigger("input")})),body.off("click",".input-group .delete-dest").on("click",".input-group .delete-dest",(function(e){e.stopImmediatePropagation(),(0,_jquery.default)(this).closest(".input-group").remove(),(0,_jquery.default)('.input-group [type="text"]').trigger("input")})),body.off("click",".input-group .goto-dest").on("click",".input-group .goto-dest",(async function(e){e.stopImmediatePropagation(),(0,_jquery.default)("#annotation-canvas #badge-preview").remove();const timestamp=(0,_jquery.default)(this).closest(".input-group").find("input.timestamp-input").val(),seconds=self.convertHMSToSeconds(timestamp),position=(0,_jquery.default)(this).closest(".input-group").find(".positionoption").val(),badgeid=(0,_jquery.default)(this).closest(".input-group").find(".badgeoption").val(),$badge=(0,_jquery.default)('.rg_badge_item[data-id="'.concat(badgeid,'"]')).clone(),xp=(0,_jquery.default)(this).closest(".input-group").find(".xp").val();xp>0&&$badge.append('<small class="text-muted">\n                    '.concat(xp," <sup>").concat(M.util.get_string("xp","mod_interactivevideo"),"</sup></span>"));let classes=self.getPosition(position);await self.player.getCurrentTime()!=seconds&&await self.player.seek(seconds),(0,_jquery.default)("#annotation-canvas").append((0,_jquery.default)('<div id="badge-preview" class="d-flex h-100 w-100 '+classes+' p-2 z-index-1"></div>').append($badge))})),body.off("contextmenu",".input-group .timestamp-input").on("contextmenu",".input-group .timestamp-input",(async function(e){e.preventDefault(),e.stopImmediatePropagation();let currentTime=await self.player.getCurrentTime();(0,_jquery.default)(this).val(self.convertSecondsToHMS(currentTime)),(0,_jquery.default)(this).trigger("input")})),body.on("input",".input-group :input",(function(){let dest=[];(0,_jquery.default)("#destination-list .input-group").each((function(){const badgeid=(0,_jquery.default)(this).find(".badgeoption").val(),xp=(0,_jquery.default)(this).find(".xp").val()||0,position=(0,_jquery.default)(this).find(".positionoption").val(),$timestamp=(0,_jquery.default)(this).find(".timestamp-input"),uniqueid=(0,_jquery.default)(this).find(".uniqueid").val();if(""!=uniqueid&&""!=badgeid&&$timestamp.val()&&!$timestamp.hasClass("is-invalid")){const seconds=self.convertHMSToSeconds($timestamp.val());dest.push({badgeid:badgeid,xp:xp,position:position,timestamp:seconds,uniqueid:uniqueid})}})),dest.sort(((a,b)=>a.timestamp-b.timestamp)),dest=dest.filter(((d,i)=>0==i||d.timestamp!=dest[i-1].timestamp&&d.uniqueid!=dest[i-1].uniqueid));let totalxp=0;dest.forEach((d=>{totalxp+=Number(d.xp)})),0==dest.length?((0,_jquery.default)("form [name=content]").val(""),(0,_jquery.default)("form [name=xp]").val(0)):((0,_jquery.default)("form [name=content]").val(JSON.stringify(dest)),(0,_jquery.default)("form [name=xp]").val(totalxp))})),(0,_jquery.default)(document).off("timeupdate.rajabsgames").on("timeupdate.rajabsgames",(async function(){(0,_jquery.default)("#annotation-canvas #badge-preview").remove()})),{form:form,event:event}}async runInteraction(annotation){(0,_jquery.default)(".tooltip").remove(),await this.player.pause();let self=this,dest=JSON.parse(annotation.content);if(dest=dest.filter((d=>!self.isSkipped(d.timestamp))),self.isEditMode()||(annotation.viewed=!0,this.annotations=this.annotations.filter((d=>d.id!=annotation.id)),this.annotations.push(annotation)),0==dest.length)return void this.player.play();let newannotation=JSON.parse(JSON.stringify(annotation));newannotation.content=JSON.stringify(dest),self.cache[annotation.id]&&!self.isEditMode()||(self.cache[annotation.id]=await this.render(newannotation,"json"));const data=self.cache[annotation.id];let $html='<div class="position-absolute decision text-center mx-auto w-100">\n            <h5 class="pt-5 pb-3 bg-white" id="decision-q">\n            <i class="mb-2 bi bi-signpost-split-fill" style="font-size: 2em"></i><br>'.concat(newannotation.formattedtitle,"</h5>");data.forEach(((dest,order)=>{$html+='<a href="javascript:void(0)" data-timestamp="'.concat(dest.timestamp,'"\n                 data-order="').concat(order,'" class="decision-option btn btn-outline-secondary btn-rounded mb-2 d-flex\n                  justify-content-between align-items-center mx-auto"><span class="text-truncate">').concat(dest.title,'</span>\n                  <i class="bi bi-chevron-right"></i></a>')})),$html+="</div>";let $message=(0,_jquery.default)('<div id="message" style="z-index:1005;display:none;" data-id="'.concat(annotation.id,'" tabindex="0">\n            <div class="modal-body p-0 border" id="content">').concat($html,"</div></div>"));(0,_jquery.default)("#video-wrapper").find("#message").remove(),(0,_jquery.default)("#video-wrapper").append($message),$message.fadeIn(300,"swing",(async function(){(0,_jquery.default)("body").addClass("disablekb"),document.querySelector("#message[data-id='".concat(annotation.id,"']")).focus(),1==annotation.char1&&$message.append('<button class="btn btn-secondary btn-rounded position-absolute"\n                     id="close-decision" style="right: 1rem; top: 1rem;">\n                     '.concat(M.util.get_string("skip","local_ivdecision"),'\n                     <i class="iv-ml-2 bi bi-chevron-right"></i></button>')),(0,_jquery.default)(document).off("click","#close-decision").on("click","#close-decision",(function(e){e.preventDefault(),e.stopImmediatePropagation(),self.player.play(),(0,_jquery.default)("#taskinfo").fadeIn(300),(0,_jquery.default)('[data-region="chapterlists"], #controller').removeClass("no-pointer-events")})),self.isEditMode()||((0,_jquery.default)("#taskinfo").fadeOut(300),(0,_jquery.default)('[data-region="chapterlists"], #controller').addClass("no-pointer-events")),await self.player.pause()})),(0,_jquery.default)(document).off("click","#message[data-id='".concat(annotation.id,"'] .decision-option")).on("click","#message[data-id='".concat(annotation.id,"'] .decision-option"),(function(e){e.preventDefault(),e.stopImmediatePropagation();let time=Number((0,_jquery.default)(this).data("timestamp"));time<this.start?time=this.start:time>this.end&&(time=this.end),self.player.seek(time),(0,_jquery.default)("#message[data-id='".concat(annotation.id,"']")).fadeOut(300),self.player.play(),(0,_jquery.default)("#taskinfo").fadeIn(300),(0,_jquery.default)('[data-region="chapterlists"], #controller').removeClass("no-pointer-events")}))}postEditCallback(){}renderEditItem(annotations,listItem,item){return(listItem=super.renderEditItem(annotations,listItem,item)).find('[data-editable="xp"]').removeAttr("data-editable"),listItem}}return _exports.default=RajabsGames,_exports.default}));

//# sourceMappingURL=main.min.js.map